// src/frontend/src/components/WeeklyCalendar/CalendarGrid.js
import React, { useState, useEffect } from 'react';
import GroupedIssueCard from './GroupedIssueCard';
import OverdueIssueCard from './OverdueIssueCard';
import apiService from '../../services/api';

const CalendarGrid = ({ days, formatDate, onCardClick, onDateClick }) => {
  console.log('üé® CalendarGrid rendered');

  // Geciken i≈üleri saklamak i√ßin state
  const [overdueIssuesMap, setOverdueIssuesMap] = useState(new Map());
  const [loading, setLoading] = useState(false);

  // Her g√ºn ve grup i√ßin geciken i≈üleri kontrol et
  useEffect(() => {
    const checkOverdueIssues = async () => {
      if (!days || days.length === 0) return;
      
      setLoading(true);
      const newOverdueMap = new Map();

      try {
        for (const day of days) {
          const dayDate = new Date(day.date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          dayDate.setHours(0, 0, 0, 0);
          
          // Sadece bug√ºn veya ge√ßmi≈ü tarihler i√ßin kontrol yap
          if (dayDate <= today) {
            for (const group of day.groupedProductions || []) {
              try {
                // Bu grup i√ßin i≈üleri √ßek
                const response = await apiService.getIssuesByDateAndType({
                  date: day.date.split('T')[0],
                  projectId: group.projectId,
                  productionType: group.productionType
                });

                // Geciken i≈üleri say
                let overdueCount = 0;
                let hasOverdueExtension = false;

                response.issues?.forEach(issue => {
                  if (issue.plannedEndDate) {
                    const plannedEnd = new Date(issue.plannedEndDate);
                    plannedEnd.setHours(0, 0, 0, 0);
                    
                    // √ñrnek 1: ƒ∞≈ü a√ßƒ±k veya √ßalƒ±≈üƒ±yor ve planlanan biti≈ü ge√ßmi≈ü
                    if (!issue.isClosed && dayDate > plannedEnd) {
                      overdueCount++;
                      hasOverdueExtension = true;
                    }
                    
                    // √ñrnek 2: ƒ∞≈ü kapanmƒ±≈ü ama planlanan biti≈ü tarihinden sonra kapanmƒ±≈ü
                    if (issue.isClosed && issue.closedOn) {
                      const closedDate = new Date(issue.closedOn);
                      closedDate.setHours(0, 0, 0, 0);
                      
                      // Planlanan biti≈ü ile kapanma tarihi arasƒ±ndaki g√ºnlerde g√∂ster
                      if (closedDate > plannedEnd && dayDate > plannedEnd && dayDate <= closedDate) {
                        overdueCount++;
                        hasOverdueExtension = true;
                      }
                    }
                  }
                });

                if (hasOverdueExtension) {
                  const key = `${day.date}_${group.projectId}_${group.productionType}`;
                  newOverdueMap.set(key, {
                    group,
                    overdueCount,
                    date: day.date
                  });
                }
              } catch (error) {
                console.error('Error checking overdue issues:', error);
              }
            }
          }
        }

        setOverdueIssuesMap(newOverdueMap);
      } catch (error) {
        console.error('Error in checkOverdueIssues:', error);
      } finally {
        setLoading(false);
      }
    };

    checkOverdueIssues();
  }, [days]);

  const isToday = (dateInput) => {
    try {
      const today = new Date();
      const checkDate = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;

      return today.getFullYear() === checkDate.getFullYear() &&
        today.getMonth() === checkDate.getMonth() &&
        today.getDate() === checkDate.getDate();
    } catch (error) {
      console.error('Error checking isToday:', error);
      return false;
    }
  };

  const handleDateHeaderClick = (date, event) => {
    event.stopPropagation();
    console.log('üñ±Ô∏è Date header clicked in CalendarGrid:', date);
    
    if (onDateClick) {
      onDateClick(date);
    }
  };

  return (
    <div className="calendar-grid">
      {days?.map((day, index) => {
        // Geciken i≈üleri bu g√ºn i√ßin topla
        const overdueGroupsForDay = [];
        const normalGroupIds = new Set();
        
        // Normal i≈ülerin ID'lerini topla
        day.groupedProductions?.forEach(group => {
          normalGroupIds.add(`${group.projectId}_${group.productionType}`);
        });
        
        // Geciken i≈üleri kontrol et
        day.groupedProductions?.forEach(group => {
          const key = `${day.date}_${group.projectId}_${group.productionType}`;
          if (overdueIssuesMap.has(key)) {
            overdueGroupsForDay.push({
              ...group,
              overdueData: overdueIssuesMap.get(key)
            });
          }
        });

        return (
          <div
            key={index}
            className={`calendar-day-card ${isToday(day.date) ? 'today' : ''}`}
          >
            {/* Day Header - Tƒ±klanabilir */}
            <div 
              className="day-header clickable-date-header"
              onClick={(e) => handleDateHeaderClick(day.date, e)}
              role="button"
              tabIndex={0}
              onKeyPress={(e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  handleDateHeaderClick(day.date, e);
                }
              }}
            >
              <div className="day-name">{day.dayName}</div>
              <div className="day-date">{formatDate(day.date)}</div>
              
              {/* Toplam i≈ü sayƒ±sƒ± badge */}
              {(day.groupedProductions?.length > 0) && (
                <span className="badge bg-light text-dark position-absolute top-0 end-0 m-2">
                  {day.groupedProductions?.length || 0}
                </span>
              )}
              
              {/* Gecikme uyarƒ±sƒ± badge */}
              {overdueGroupsForDay.length > 0 && (
                <span className="badge bg-danger position-absolute top-0 start-0 m-2">
                  <i className="bi bi-exclamation-triangle-fill me-1"></i>
                  {overdueGroupsForDay.length}
                </span>
              )}
              
              <div className="date-click-hint">
                <i className="bi bi-box-arrow-up-right"></i>
              </div>
            </div>

            {/* Day Issues */}
            <div className="day-issues">
              {loading && (
                <div className="text-center py-2">
                  <div className="spinner-border spinner-border-sm text-danger" role="status">
                    <span className="visually-hidden">Y√ºkleniyor...</span>
                  </div>
                </div>
              )}

              {/* Normal i≈üler */}
              {day.groupedProductions && day.groupedProductions.length > 0 ? (
                day.groupedProductions.map((group, groupIndex) => {
                  // Bu grup i√ßin gecikme var mƒ±?
                  const key = `${day.date}_${group.projectId}_${group.productionType}`;
                  const hasOverdue = overdueIssuesMap.has(key);

                  // Eƒüer gecikme varsa, sadece OverdueCard g√∂ster
                  if (hasOverdue) {
                    const overdueData = overdueIssuesMap.get(key);
                    return (
                      <OverdueIssueCard
                        key={`overdue-${groupIndex}`}
                        group={group}
                        overdueCount={overdueData?.overdueCount}
                        onClick={() => {
                          console.log('üö® Overdue card clicked:', group);
                          if (onCardClick) {
                            onCardClick(group, day.date);
                          }
                        }}
                      />
                    );
                  }

                  // Gecikme yoksa normal kart g√∂ster
                  return (
                    <GroupedIssueCard
                      key={`normal-${groupIndex}`}
                      group={group}
                      onClick={() => {
                        console.log('üìå Normal card clicked:', group);
                        if (onCardClick) {
                          onCardClick(group, day.date);
                        }
                      }}
                    />
                  );
                })
              ) : null}

              {/* Hi√ß i≈ü yoksa */}
              {(!day.groupedProductions || day.groupedProductions.length === 0) && !loading && (
                <div className="text-center py-4">
                  <i className="bi bi-inbox text-muted" style={{ fontSize: '2rem' }}></i>
                  <p className="text-muted mb-0 mt-2" style={{ fontSize: '0.85rem' }}>
                    ƒ∞≈ü bulunmuyor
                  </p>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
};

export default CalendarGrid;